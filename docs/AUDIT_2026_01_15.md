# Audit code GeneHub — 15 Janvier 2026

## Portée
- Documentation lue: [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md), [docs/DEVELOPMENT_PLAN.md](docs/DEVELOPMENT_PLAN.md), [docs/STRATEGY.md](docs/STRATEGY.md)
- Zones de code inspectées (échantillon large):
  - Knowledge Base services: [src/lib/knowledge](src/lib/knowledge)
  - Inbox: [src/lib/inbox](src/lib/inbox), hook [src/lib/hooks/useInbox.ts](src/lib/hooks/useInbox.ts)
  - Cache & data layer: [src/lib/cache.ts](src/lib/cache.ts), [src/lib/dataLayer.ts](src/lib/dataLayer.ts), [src/lib/storage.ts](src/lib/storage.ts)
  - Recherche: [src/lib/globalSearch.ts](src/lib/globalSearch.ts), [src/lib/knowledge/search.service.ts](src/lib/knowledge/search.service.ts)
  - Auth & Supabase: [src/lib/auth.ts](src/lib/auth.ts), [src/lib/supabase.ts](src/lib/supabase.ts)

## Synthèse rapide
- Le code est globalement propre, tests nombreux et services bien isolés.
- Les points les plus critiques sont des **incohérences de modèle de données**, des **incohérences de conventions** (tags), et des **duplicatas d’architecture (cache/data layer)** qui complexifient le système.

## Constats (du plus au moins critique)

### P0 — Critique
1) **Contradiction sur le modèle de données “public vs private”**
   - Les commentaires de services indiquent “données isolées par user_id + RLS”, mais la doc dit “lecture partagée pour articles/chercheurs/conférences”.
   - Les listes ne filtrent pas par `user_id` (ex: [src/lib/knowledge/articles.service.ts](src/lib/knowledge/articles.service.ts), [src/lib/knowledge/researchers.service.ts](src/lib/knowledge/researchers.service.ts), [src/lib/knowledge/conferences.service.ts](src/lib/knowledge/conferences.service.ts)).
   - **Risque**: logique d’accès et confidentialité ambiguës, comportement dépendant de la config RLS.

2) **Convention de tags non alignée avec l’implémentation**
   - La doc décrit un format `symbol-orgcode` et des règles de naming; l’auto-tagging utilise un préfixe emoji + `entityName` (voir [src/lib/knowledge/tags.service.ts](src/lib/knowledge/tags.service.ts)).
   - **Risque**: doublons de tags, incohérence UX et données fragmentées.
   - Conflit avec “Pas d’emoji” dans la stratégie design (voir [docs/STRATEGY.md](docs/STRATEGY.md)).

### P1 — Élevé
3) **Bug logique “all” dans l’inbox**
   - `status: 'all'` appelle `listActiveInbox()` qui exclut les items archivés (voir [src/lib/hooks/useInbox.ts](src/lib/hooks/useInbox.ts) et [src/lib/inbox/inbox.service.ts](src/lib/inbox/inbox.service.ts)).
   - **Impact**: “all” ne signifie pas vraiment “tout”.

4) **Relations collaborateur asymétriques possibles**
   - `linkResearcherCollaborator()` insère deux lignes; si une relation existe déjà, l’insert échoue globalement, laissant potentiellement l’autre direction absente.
   - Absence de garde contre `researcherId === collaboratorId` (voir [src/lib/knowledge/researchers.service.ts](src/lib/knowledge/researchers.service.ts)).

5) **N+1 queries sur notes/tags**
   - `listNotesForEntity()`, `listAllNotes()` et `getNotesForTag()` font une requête par note pour récupérer les tags (voir [src/lib/knowledge/notes.service.ts](src/lib/knowledge/notes.service.ts) et [src/lib/knowledge/tags.service.ts](src/lib/knowledge/tags.service.ts)).
   - **Impact**: latence élevée dès que la base grossit.

### P2 — Moyen
6) **Deux systèmes de cache en parallèle**
   - `src/lib/cache.ts` et `src/lib/dataLayer.ts` implémentent des caches différents pour les gènes et les listes KB.
   - `useGeneData` utilise `cache.ts` alors que `globalSearch` utilise `geneDataLayer` (voir [src/lib/hooks/useGeneData.ts](src/lib/hooks/useGeneData.ts) et [src/lib/globalSearch.ts](src/lib/globalSearch.ts)).
   - **Impact**: incohérences, effort de maintenance doublé, comportement difficile à prédire.

7) **Recherche KB: erreurs silencieuses et requêtes non filtrées**
   - `searchAll()` ignore les erreurs Supabase (voir [src/lib/knowledge/search.service.ts](src/lib/knowledge/search.service.ts)).
   - `globalSearch()` appelle `searchAll()` même si l’utilisateur ne veut qu’un type (voir [src/lib/globalSearch.ts](src/lib/globalSearch.ts)).

### P3 — Faible
8) **Comptage des tags coûteux**
   - `getTagsWithCounts()` fait une requête par tag (voir [src/lib/knowledge/tags.service.ts](src/lib/knowledge/tags.service.ts)).

9) **Déconnexion: ordre discutable**
   - Le nettoyage local est fait avant `signOut`, ce qui peut empêcher l’invalidation serveur (voir [src/lib/auth.ts](src/lib/auth.ts)).

## Recommandations (du plus au moins critique)

### P0 — Critique
1) **Décider et documenter clairement la politique RLS “public vs private”**
   - Harmoniser doc + services + migrations.
   - Appliquer les mêmes règles pour articles/chercheurs/conférences.

2) **Normaliser la convention des tags**
   - Centraliser la génération du nom et la règle `entity_id`.
   - Supprimer les emojis de noms si la stratégie “no emoji” est maintenue.

### P1 — Élevé
3) **Corriger la logique “all” de l’inbox**
   - Ajouter un vrai `listAllInbox()` ou inclure `archived` dans `listActiveInbox()`.

4) **Sécuriser les collaborateurs**
   - Utiliser un `upsert` bidirectionnel ou une contrainte/trigger pour garantir la symétrie.
   - Bloquer le cas `researcherId === collaboratorId`.

5) **Optimiser la récupération notes/tags**
   - Utiliser `select` avec jointures Supabase pour récupérer notes + tags en une requête.
   - Option: endpoint RPC pour les notes d’entité.

### P2 — Moyen
6) **Fusionner les systèmes de cache**
   - Choisir `dataLayer` ou `cache.ts`, pas les deux.
   - Exposer une API unique (SWR + TTL) pour gènes + KB.

7) **Durcir la recherche**
   - Ajouter `wrapError()` dans `searchAll`.
   - Utiliser `searchWithFilters()` dans `globalSearch()` pour éviter des requêtes inutiles.

### P3 — Faible
8) **Optimiser le comptage tags**
   - Remplacer N+1 par un group-by ou une vue matérialisée.

9) **Revoir l’ordre de `signOut()`**
   - Appeler `supabase.signOut` avant le nettoyage local, puis fallback si erreur.

## Actions réalisées (15 Jan 2026)
- Correction du mode “all” inbox pour inclure les archivés (voir [src/lib/inbox/inbox.service.ts](src/lib/inbox/inbox.service.ts) et [src/lib/hooks/useInbox.ts](src/lib/hooks/useInbox.ts)).
- Sécurisation des collaborateurs (anti auto-lien + insertion symétrique robuste) (voir [src/lib/knowledge/researchers.service.ts](src/lib/knowledge/researchers.service.ts)).
- Harmonisation auto-tagging avec la convention de tags (suppression emoji, noms normalisés) (voir [src/lib/knowledge/tags.service.ts](src/lib/knowledge/tags.service.ts)).
- Documentation RLS alignée avec l’isolation par user_id (voir [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md), [docs/STRATEGY.md](docs/STRATEGY.md), [docs/DEVELOPMENT_PLAN.md](docs/DEVELOPMENT_PLAN.md)).
- Optimisation notes/tags (batching pour éviter N+1) (voir [src/lib/knowledge/notes.service.ts](src/lib/knowledge/notes.service.ts), [src/lib/knowledge/tags.service.ts](src/lib/knowledge/tags.service.ts)).
- `searchAll` durci avec gestion d’erreurs (voir [src/lib/knowledge/search.service.ts](src/lib/knowledge/search.service.ts)).
- Recherche KB filtrée pour éviter des requêtes inutiles (voir [src/lib/globalSearch.ts](src/lib/globalSearch.ts)).
- Unification cache gènes (clé + storage unique) (voir [src/lib/dataLayer.ts](src/lib/dataLayer.ts), [src/lib/cache.ts](src/lib/cache.ts)).
- Optimisation counts tags (batch note_tags) (voir [src/lib/knowledge/tags.service.ts](src/lib/knowledge/tags.service.ts)).
- Ordre `signOut()` corrigé (supabase d’abord, cleanup ensuite) (voir [src/lib/auth.ts](src/lib/auth.ts)).
